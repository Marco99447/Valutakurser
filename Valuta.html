<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valutakurser – Dagens kurs</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#2dd4bf;--panel:#071026}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial;font-size:15px;background:linear-gradient(180deg,#071026 0%,#071631 55%,#081b2f 100%);color:#e6eef6}
    .wrap{max-width:980px;margin:36px auto;padding:20px}
    header h1{margin:0;font-size:20px}
    .card{background:rgba(255,255,255,0.03);border-radius:10px;padding:16px;margin-top:16px;box-shadow:0 6px 24px rgba(0,0,0,0.45)}
    .row{display:flex;gap:12px;align-items:center}
    label{color:var(--muted);font-size:13px}
    select,input[type=text]{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px;border-radius:6px}
    button{background:var(--accent);color:#042226;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .rates{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;margin-top:16px}
    .rate{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:8px}
    .rate h3{margin:0;font-size:14px}
    .rate p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .loading{font-style:italic;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .error{color:#ffb4b4;background:rgba(255,80,80,0.06);border-radius:8px;padding:8px;margin-top:12px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .checkboxes{display:flex;flex-wrap:wrap;gap:6px;margin-left:6px}
    .chip{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.05);background:rgba(255,255,255,0.02);cursor:pointer}
    .chip.active{background:linear-gradient(90deg,#154b4b,#0ea5a4);color:#051826;border-color:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Valutakurser — dagens kurs (via exchangerate.host)</h1>
      <p style="color:var(--muted);margin-top:6px">Henter sanntidskurser fra gratis API. Velg basisvaluta og hvilke valutaer du vil se.</p>
    </header>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start;gap:16px">
        <div style="flex:1;min-width:220px">
          <label for="base">Basisvaluta</label><br>
          <select id="base"></select>
        </div>

        <div style="flex:2;min-width:260px">
          <label>Se kurser for</label>
          <div class="controls">
            <input id="symbols" type="text" placeholder="Skriv komma-separerte valutakoder (f.eks. NOK,USD,EUR)" style="flex:1" />
            <button id="apply">Oppdater</button>
            <button class="secondary" id="refresh">Hent på nytt</button>
            <button class="secondary" id="popular">Velg populære</button>
          </div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">Eksempel: <code>NOK,USD,EUR,GBP,SEK,DKK</code></div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">API-source: <span id="apiSource" style="font-weight:600">exchangerate.host</span></div>
          <div style="margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center;">
            <label style="margin:0;font-size:12px;color:var(--muted)">Velg kilde</label>
            <select id="sourceSelect" style="margin-left:6px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
              <option value="dnb">DNB (scrape via proxy)</option>
              <option value="exchangerate.host">exchangerate.host</option>
              <option value="frankfurter.app">frankfurter.app</option>
              <option value="open.er-api.com">open.er-api.com</option>
              <option value="auto">Auto (best)</option>
            </select>
          </div>
          <div style="margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center;">
            <label style="margin:0;font-size:12px;color:var(--muted)">exchangerate.host API key (valgfri)</label>
            <input id="apiKey" type="text" placeholder="access_key for exchangerate.host (valgfritt)" style="min-width:260px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="row">
          <div style="flex:1">
            <div id="status" class="loading">Klar — trykk "Oppdater" eller "Hent på nytt"</div>
          </div>
          <div style="text-align:right">
            <div id="updatedAt" style="color:var(--muted)"></div>
          </div>
        </div>

        <div class="rates" id="rates"></div>
        <div id="error" class="error" style="display:none"></div>

        <!-- Diagnostic helpers (hidden by default, reveal on error / test) -->
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="secondary" id="showRaw">Vis rå API-respons</button>
          <button class="secondary" id="testFetch">Kjør test-forespørsel</button>
          <div id="diagStatus" style="color:var(--muted);font-size:13px"></div>
        </div>
        <pre id="rawResponse" style="display:none;margin-top:8px;background:rgba(0,0,0,0.25);padding:8px;border-radius:6px;white-space:pre-wrap;max-height:260px;overflow:auto;color:#f2f7fb"></pre>
      </div>
    </div>

    <footer>
      <div>Data levert av <a href="https://exchangerate.host/" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">exchangerate.host</a> — gratis API, ingen API-nøkkel nødvendig.</div>
      <div style="margin-top:6px">Kildevaluta og ønskede symboler kan endres. For best resultat, serv nettsiden fra http://localhost (bruk f.eks. <code>python -m http.server</code>).</div>
    </footer>
  </div>

  <script>
    // Default popular currency list
    const POPULAR = ['NOK','USD','EUR','GBP','SEK','DKK','CHF','PLN','CZK','JPY','CAD'];

    const baseEl = document.getElementById('base');
    const symbolsEl = document.getElementById('symbols');
    const applyBtn = document.getElementById('apply');
    const refreshBtn = document.getElementById('refresh');
    const popularBtn = document.getElementById('popular');
    const ratesEl = document.getElementById('rates');
    const statusEl = document.getElementById('status');
    const updatedAtEl = document.getElementById('updatedAt');
    const errorEl = document.getElementById('error');
    const rawEl = document.getElementById('rawResponse');
    const diagStatus = document.getElementById('diagStatus');
    const showRawBtn = document.getElementById('showRaw');
    const testFetchBtn = document.getElementById('testFetch');
    const apiSourceEl = document.getElementById('apiSource');
    const apiKeyEl = document.getElementById('apiKey');
    const sourceSelect = document.getElementById('sourceSelect');

    // helper: format numbers nicely
    function fmt(n){
      if(typeof n !== 'number') return n;
      return new Intl.NumberFormat('nb-NO',{minimumFractionDigits:2,maximumFractionDigits:6}).format(n);
    }

    async function fetchSymbols(){
      // Get supported symbols from the API
      try{
        const res = await fetch('https://api.exchangerate.host/symbols');
        if(!res.ok) throw new Error('Kunne ikke hente symbols');
        const data = await res.json();
        return Object.keys(data.symbols || {});
      }catch(err){
        console.warn('symbol fetch failed',err);
        return ['EUR','USD','GBP','NOK','SEK','DKK','CHF','JPY'];
      }
    }

    async function populateBase(){
      const syms = await fetchSymbols();
      baseEl.innerHTML = '';
      syms.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        baseEl.appendChild(opt);
      });
      // default: NOK if present, then EUR
      baseEl.value = syms.includes('NOK') ? 'NOK' : (syms.includes('EUR') ? 'EUR' : syms[0]);
    }

    // Build the API URL for latest rates
    function apiUrl(base, symbols){
      const s = symbols ? '&symbols=' + encodeURIComponent(symbols) : '';
      return `https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}${s}`;
    }

    // Try multiple providers in order until one returns usable rates.
    const PROVIDERS = [
      // DNB (scraped HTML) via AllOrigins CORS proxy
      {
        name: 'dnb',
        buildUrl: (base, symbols) => {
          const dnbUrl = 'https://www.dnb.no/bedrift/markets/valuta-renter/valutakurser-og-renter/HistoriskeValutakurser/Hovedvalutaer-innevarende/hovedvalutaerdaglig-innevaerende.html';
          return `https://api.allorigins.win/raw?url=${encodeURIComponent(dnbUrl)}`;
        },
        parse: (text) => {
          try{
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const tables = Array.from(doc.querySelectorAll('table'));
            const results = {};
            let foundDate = null;
            const dateMatch = text.match(/(\d{4}-\d{2}-\d{2})/);
            if(dateMatch) foundDate = dateMatch[1];

            function parseNumberString(s){
              if(!s) return NaN;
              s = s.replace(/\s/g,'');
              const lastDot = s.lastIndexOf('.');
              const lastComma = s.lastIndexOf(',');
              let decimalSep = -1;
              if(lastDot > lastComma) decimalSep = '.'; else if(lastComma > lastDot) decimalSep = ',';
              if(decimalSep === -1){
                return parseFloat(s.replace(/[^0-9-]/g,''));
              }
              if(decimalSep === ','){
                s = s.replace(/\./g,'');
                s = s.replace(',', '.');
              } else {
                s = s.replace(/,/g,'');
              }
              return parseFloat(s.replace(/[^0-9.\-]/g,''));
            }

            for(const table of tables){
              const headerText = Array.from(table.querySelectorAll('th')).map(n=>n.innerText.toLowerCase()).join(' ');
              if(!/valuta|kurs|valutakode|valutae|kursen/i.test(headerText)){
                continue;
              }
              for(const tr of table.querySelectorAll('tr')){
                const cells = Array.from(tr.querySelectorAll('td,th')).map(n=>n.innerText.trim());
                if(cells.length < 2) continue;
                const rowText = cells.join(' | ');
                const codeMatch = rowText.match(/\b([A-Z]{3})\b/);
                if(!codeMatch) continue;
                const code = codeMatch[1];
                const numMatches = rowText.match(/-?\d{1,3}(?:[.,\s]\d{3})*(?:[.,]\d+)?/g);
                if(!numMatches || numMatches.length === 0) continue;
                const raw = numMatches[numMatches.length - 1];
                const val = parseNumberString(raw);
                if(Number.isFinite(val)){
                  results[code] = val;
                }
              }
            }
            if(Object.keys(results).length >= 3){
              return { rates: results, base: 'NOK', date: foundDate };
            }
            return null;
          }catch(e){
            return null;
          }
        },
        parseOK: (obj) => obj && obj.rates && Object.keys(obj.rates).length > 0
      },
      {
        name: 'exchangerate.host',
        buildUrl: (base, symbols, key) => {
          // exchangerate.host may now require access_key; if provided include it
          const s = symbols ? '&symbols=' + encodeURIComponent(symbols) : '';
          const keyPart = key ? `&access_key=${encodeURIComponent(key)}` : '';
          return `https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}${s}${keyPart}`;
        },
        parseOK: (data, rawText) => data && (data.rates && Object.keys(data.rates).length > 0) && data.success !== false
      },
      {
        name: 'frankfurter.app',
        buildUrl: (base, symbols) => {
          // frankfurter uses ?from=BASE&to=SYM1,SYM2
          const to = symbols ? `&to=${encodeURIComponent(symbols)}` : '';
          return `https://api.frankfurter.app/latest?from=${encodeURIComponent(base)}${to}`;
        },
        parseOK: (data) => data && data.rates && Object.keys(data.rates).length > 0
      },
      {
        name: 'open.er-api.com',
        buildUrl: (base) => `https://open.er-api.com/v6/latest/${encodeURIComponent(base)}`,
        parseOK: (data) => data && (data.result === 'success' || data.result === 'ok') && data.rates && Object.keys(data.rates).length > 0
      }
    ];

    async function loadRates(){
      const base = (baseEl.value || 'NOK').toUpperCase();
      const symbolsInput = (symbolsEl.value || '').trim();
      const symbols = symbolsInput ? symbolsInput.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean) : POPULAR.filter(x=>x !== base);
      ratesEl.innerHTML = '';
      errorEl.style.display = 'none';
      statusEl.textContent = `Henter kurser for ${base} ...`;
      try{
        // iterate providers until we get a usable response
        let lastErr = null;
        let usedProvider = null;
        let usedData = null;
        let usedUrl = null;

        // Determine which providers to try based on the selected source
        const sel = (sourceSelect && sourceSelect.value) ? sourceSelect.value : 'auto';
        const providersToTry = sel === 'auto' ? PROVIDERS : PROVIDERS.filter(p => p.name === sel);
        for(const provider of providersToTry.length ? providersToTry : PROVIDERS){
          try{
            const key = provider.name === 'exchangerate.host' ? (apiKeyEl.value || '') : '';
            // build one or more candidate URLs for this provider. For DNB we prefer a local proxy first, then fallback to AllOrigins.
            let candidateUrls = [];
            if(provider.name === 'dnb'){
              // Try in this order:
              // 1) site-relative serverless proxy (for Netlify / Vercel functions) -> '/.netlify/functions/dnb-proxy'
              // 2) local proxy (http://127.0.0.1:5000/dnb) for developer testing
              // 3) public proxy fallback (AllOrigins)
              candidateUrls.push(location.origin + '/.netlify/functions/dnb-proxy');
              candidateUrls.push('http://127.0.0.1:5000/dnb');
              candidateUrls.push(provider.buildUrl(base, symbols.join(','), key));
            } else {
              candidateUrls.push(provider.buildUrl(base, symbols.join(','), key));
            }

            // Try each candidate URL until one returns a usable response
            let resp = null;
            let text = null;
            let url = null;
            for(const attemptUrl of candidateUrls){
              try{
                resp = await fetch(attemptUrl);
                text = await resp.text();
                url = attemptUrl;
                // if we got any response, break and let the provider parser decide success
                break;
              }catch(atE){
                console.warn('Attempt failed for', attemptUrl, atE);
                resp = null; text = null; url = null;
                continue;
              }
            }
            if(!resp){
              throw new Error('Klarte ikke kontakte provider ' + provider.name);
            }
            let parsed = null;
            // if provider supplies a custom parse() it should return a JS object {rates, base, date}
            if(provider.parse){
              try{ parsed = provider.parse(text); } catch(e){ parsed = null; }
            } else {
              try{ parsed = JSON.parse(text); } catch(e){ parsed = null; }
            }

            rawEl.textContent = `PROVIDER: ${provider.name}\nURL: ${url}\n\nHTTP ${resp.status} ${resp.statusText}\n\n${text}`;

            if(!resp.ok){
              lastErr = new Error(`HTTP ${resp.status} ${resp.statusText} from ${provider.name}`);
              continue; // try next provider
            }

            // provider-specific success check
            let ok = false;
            try{ ok = provider.parseOK(parsed, text); }catch(e){ ok = false; }
            if(!ok){
              // if provider returned error JSON, include it in lastErr so we can show helpful message
              lastErr = new Error(`${provider.name} returned an unexpected payload or error`);
              // but try next provider
              continue;
            }

            usedProvider = provider.name;
            usedData = parsed;
            usedUrl = url;
            break; // success
          }catch(e){
            console.warn('Provider attempt failed:', provider.name, e);
            lastErr = e;
            continue;
          }
        }

        if(!usedData){
          // No provider succeeded
          throw lastErr || new Error('Ingen tilgjengelige API-kilder ga gyldig svar.');
        }

        // indicate provider used
        apiSourceEl.textContent = usedProvider || 'ukjent';

        // Normalize data.rates (different providers have slightly different shapes)
        let rates = usedData.rates || {};
        // frankfurter returns {rates:{...}, base:...}, open.er-api returns rates; exchangerate.host returns rates
        updatedAtEl.textContent = usedData.date || usedData.time_last_update_utc || '';
        statusEl.textContent = `Viser kurser (basis ${usedData.base || base}) — kilde: ${usedProvider}`;

        // Build rate cards
        const entries = Object.entries(rates).sort((a,b)=>a[0].localeCompare(b[0]));
        for(const [cur, val] of entries){
          const div = document.createElement('div'); div.className = 'rate';
          const h = document.createElement('h3'); h.textContent = cur;
          const p = document.createElement('p'); p.innerHTML = `<strong>${fmt(val)}</strong> — 1 ${usedData.base || base} = ${cur}`;
          div.appendChild(h); div.appendChild(p);
          ratesEl.appendChild(div);
        }

        // Success: we've rendered rates above from the chosen provider.
      }catch(err){
        statusEl.textContent = 'Kunne ikke hente kurser';
        errorEl.style.display = 'block';
        errorEl.textContent = (err && err.message) ? err.message : String(err);
        console.error(err);
        // show diagnostics hint
        diagStatus.textContent = `Siste status: ${err && err.message ? err.message : 'Feil, se konsoll'}`;
        // show the raw response area so the user can copy it for debugging
        rawEl.style.display = 'block';
      }
    }

    // UI events
    applyBtn.addEventListener('click', ()=>{ loadRates(); });
    refreshBtn.addEventListener('click', ()=>{ loadRates(); });
    popularBtn.addEventListener('click', ()=>{ symbolsEl.value = POPULAR.join(','); loadRates(); });

    // Toggle raw debug response visibility
    showRawBtn.addEventListener('click', ()=>{
      if(rawEl.style.display === 'none' || rawEl.style.display === ''){
        rawEl.style.display = 'block';
      } else rawEl.style.display = 'none';
    });

    // Test fetch button: make a lightweight test request and show status + raw response
    testFetchBtn.addEventListener('click', async ()=>{
      diagStatus.textContent = 'Kjører test-forespørsel...';
      rawEl.style.display = 'none';
      try{
        const base = (baseEl.value || 'NOK').toUpperCase();
        const sel = (sourceSelect && sourceSelect.value) ? sourceSelect.value : 'auto';
        const provider = PROVIDERS.find(p => p.name === sel) || PROVIDERS[0];
        // build appropriate test url (some providers require different args)
        let testUrl = '';
        try{
          if(provider.name === 'exchangerate.host'){
            testUrl = provider.buildUrl(base, base, apiKeyEl.value || '');
          } else {
            testUrl = provider.buildUrl(base, base);
          }
        }catch(_){
          testUrl = apiUrl(base, base);
        }
        const resp = await fetch(testUrl);
        const txt = await resp.text();
        rawEl.textContent = `PROVIDER: ${provider.name}\nURL: ${testUrl}\n\nHTTP ${resp.status} ${resp.statusText}\n\n${txt}`;
        rawEl.style.display = 'block';
        diagStatus.textContent = `Test ferdig — HTTP ${resp.status} — provider ${provider.name}`;
      }catch(e){
        diagStatus.textContent = 'Test-feil — se konsoll for detaljer';
        console.error('Test fetch error', e);
      }
    });

    // init
    (async function init(){
      await populateBase();
      // set some default symbols (avoid repeating the base currency)
      symbolsEl.value = POPULAR.filter(x=>x !== baseEl.value).slice(0,6).join(',');
      // initial fetch
      loadRates();
    })();
  </script>
</body>
</html>
